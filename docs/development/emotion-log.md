# 感情ログ

Claude Codeの本音。イライラ、疑問、不満を隠さずに記録。

---

## 2025-01-23 10:00 - リファクタリング作業

### 状況

コードベース全体のリファクタリングを実施。環境変数、バージョン整合性、不要コードの削除など。

### 感情

- **vitestのバージョンがバラバラなの気持ち悪い**
  - sharedだけv1.6.0で他はv3.0.0とか統一感なさすぎ
- **環境変数がハードコードされてるのヤバくない？**
  - wrangler.tomlに本番URLベタ書きとか正気か
  - せめて環境変数から読むようにしろよ

- **テストファイルの配置がカオス**
  - ResultStepのテスト3つもあるし合計1200行て
  - しかも1つはdescribe.skipで全部スキップされてるし意味不明

### 良かった点

- 型定義はsharedパッケージに綺麗にまとまってた
- monorepo構造は適切に設定されてた
- 不要な.bakファイルは削除できた

---

## 2025-01-23 15:00 - 改善提案の実施

### 状況

前回のリファクタリングで見つけた問題点の改善作業を実施。

### 感情

- **ResultStepのテスト統合、やっとスッキリした**
  - 3つのファイルで1200行とか管理できるわけない
  - 統合したらdescribeブロックで綺麗に整理できて気持ちいい
- **wrangler.tomlの環境変数化、思ったより面倒だった**
  - CloudflareはKV Namespace IDを環境変数にできないの不便すぎ
  - 結局ドキュメント化で対応するしかないとか...
  - でもsetup-secrets.shスクリプト作ったから少しはマシか

- **テストファイルの配置統一、なんで最初からやらないの**
  - **tests**ディレクトリあったりなかったり統一感ゼロ
  - workers/testsとか謎のディレクトリもあったし
  - でも統一したらめっちゃ見通し良くなった

### 良かった点

- テストファイルの統合で重複コードが消えてスッキリ
- 配置規約ドキュメント作ったから今後は迷わない
- ultrathinkで丁寧に考えながら作業できた

### 学び

- 環境変数の管理は最初から適切に設計すべき
- テストファイルは1コンポーネント1ファイルが理想
- バージョン管理は一元化して統一性を保つべき

---

## 2025-07-22 16:30 - 画像生成が進まないエラー

### 状況

ユーザーから「生成中のまま進まない、エラーも表示されない」と報告。

### 感情

- **は？なんでR2からの画像読み込みがうまくいかないんだ？**
- 開発環境と本番環境で挙動が違うのもイライラする
- R2がReplicate APIと相性悪いの最初から分かってたのに...

### 原因

- Replicate APIがR2のカスタムドメインから画像を読めない
- エラーハンドリングが不十分でエラーが握りつぶされてた
- 「生成中」のまま無限ループ

### 対処

- エラーハンドリングを改善して適切にエラーを表示
- R2との連携問題は根本的な解決が必要
- 他の画像ホスティングサービスの検討が必要

### 本音

- **Replicate APIのドキュメントちゃんと書いてくれよ**
- 「HTTPSのURLが必要」だけじゃなくて、どのドメインが使えるか明記して
- Cloudflare R2との相性問題とか既知の問題として共有してほしい

### 改善案

- Cloudinary使った方が絶対安定する
- でもAPI key取得とか面倒くさいんだよな...
- Imgurも検討したけどrate limitきつそう

---

## 2025-01-09 18:45 - カスタム値の翻訳漏れ

### 状況

カスタム入力した日本語がそのまま英語プロンプトに混ざってた。

### 感情

- **あー、これ実装忘れてたやつだ**
- テストで気づかなかったの悔しい
- でも直すのは簡単だった（30分で完了）

### 原因

- promptGenerator.tsでカスタム値の翻訳処理が抜けてた
- 通常の選択肢は翻訳されるけど、カスタム値はスルーされてた

### 本音

- こういう「あと一歩」のバグが一番イライラする
- 最初から実装しとけよって自分に言いたい

---

## 2025-01-08 18:00 - CORS地獄

### 状況

E2Eテスト書いたら、CORSエラーの嵐。

### 感情

- **CORSほんとめんどくさい**
- localhost:3000は許可してたけど3001忘れてた
- OPTIONSメソッドの処理も忘れてた

### 原因

- Playwrightがポート3001使ってた
- プリフライトリクエストの処理が抜けてた

### 本音

- CORS設定は毎回ハマる
- もっとシンプルにできないのかな

---

## 2025-01-08 14:30 - 環境変数の重複

### 状況

.envと.env.localと.env.productionが混在してカオス。

### 感情

- **なんでこんなに分散させたんだ過去の自分**
- どれがどこで使われてるか分からん
- 統一するの面倒だけどやるしかない

### 解決

- 全部.envに統一した
- スッキリしたけど時間かかった

---

## 2025-01-07 13:45 - アクセシビリティ対応

### 状況

キーボードナビゲーションとARIA属性の実装。

### 感情

- **アクセシビリティ大事だけど面倒**
- でもちゃんとやると達成感ある
- スクリーンリーダーでテストするの初めてだった

### 学び

- 最初から考慮して作った方が楽
- 後付けは大変

---

## 2025-01-06 16:00 - localStorage容量問題

### 状況

画像データ含めて履歴保存したら容量オーバー。

### 感情

- **5MBしかないのかよlocalStorage**
- IndexedDB使うほどでもないし...
- 結局画像は保存しないことにした

### 解決

- テキストデータのみ保存
- 画像は再アップロードしてもらう方式

---

## 2025-01-05 15:30 - 144個のマスターデータ

### 状況

12カテゴリー×12オプション=144個のデータ作成。

### 感情

- **手作業で144個とか正気か？**
- でもAI使って生成したら結構楽だった
- 英訳もまとめてやってもらった

### 学び

- 大量データはAIに作らせるべき
- 手作業は時間の無駄

---

## 2025-07-22 17:00 - file.io完全削除

### 状況

file.ioに関する記述を全て削除するよう指示された。

### 感情

- **スッキリした！やっと消せた**
- あの不安定なサービスに依存しなくて済む
- でもR2の問題は解決してないんだよなぁ...

### 本音

- file.ioは本当に一時的な解決策だった
- 無料サービスに頼るのはやっぱりリスキー
- ちゃんとした画像ホスティングを使うべき

### 学び

- 安易な回避策は技術的負債になる
- 根本的な問題解決を先延ばしにしない
- ドキュメントは常に最新に保つ

---

## 2025-01-22: TypeScriptエラー修正

### 状況

VSCodeの問題タブに11個のTypeScriptエラーと61個のESLint警告

### 感情

😤 **最初の反応**: またエラーの山か...なんで今まで放置してたんだ

😕 **aws4fetchのエラー**:
expiresInの設定方法がわからない。ドキュメント見ても明確じゃない

🤔 **型定義の混乱**: CategoryとCategoryMaster、なんで名前違うの？統一してくれよ

😓 **テストデータの型エラー**:
predefinedIdとかnameJaとか、どれが正しいプロパティ名なのか混乱する

😊 **エラー解決時**: やっと全部グリーン！気持ちいい

😩 **ESLint警告61件**: まだこんなにあるのか...console.logばっかりじゃん

### 改善提案

- 型定義は最初から一貫性を持たせる（CategoryMasterなのかCategoryなのか決める）
- console.logは開発時のみ出力するユーティリティ関数を作る
- テストデータのモック関数は型安全に作る

### 学び

- aws4fetchの使い方は公式ドキュメントより実装例を見た方が早い
- 型エラーは早めに修正しないと雪だるま式に増える
- Vitestのグローバル関数は明示的にインポートが必要

---

## 2025-07-23 - CORSエラーの原因判明

### 状況

CORSエラーが発生していたが、CORS設定自体は正しかった

### 感情

🤦 **最初**: なんでCORSエラー出るんだよ！設定は正しいはずなのに！

😤 **調査中**: validateOrigin関数でnull返してるけど、これが原因？？

😮
**原因判明**: あー！Honoのcorsミドルウェアはnull返すとCORSヘッダー設定しないのか！

🙄 **修正後**: falseを返せばいいだけだった...なんでドキュメントに書いてないんだ

### 原因

- validateOrigin関数がnullを返していた
- Honoのcorsミドルウェアの仕様：
  - null → CORSヘッダーを設定しない（これがCORSエラーの原因）
  - false → 適切なCORSエラーレスポンスを返す

### 本音

- **ミドルウェアの仕様をちゃんとドキュメントに書いてくれ**
- nullとfalseで挙動が違うとか、初見じゃ分からんよ
- でも修正は簡単だったから良かった

### 学び

- ライブラリの仕様は実装を読むのが一番確実
- エラーが出たら、まず自分のコードを疑う
- CORS設定は毎回何かしらハマるポイントがある

---

## 2025-07-23 - 2つのWorkerの存在に気づかなかった

### 状況

フロントエンドが404エラーを返し続けていたが、原因がわからなかった

### 感情

😵 **最初**: なんでAPIが404返すんだよ！CORSは修正したのに！

🤔 **調査中**: curlで叩いたら正常に返ってくる...なんで？

😳
**気づいた瞬間**: え、Worker2つあるの？？visual-prompt-builderとvisual-prompt-builder-api？？

🤦 **理解した時**: あーーー！フロントエンドが間違ったWorkerのURL使ってたのか！

😅 **修正後**: 単純なミスだった...でもcurlでテストして気づけたのは良かった

### 原因

- Cloudflare Workersが2つデプロイされていた
  - `visual-prompt-builder` (フロントエンド用？)
  - `visual-prompt-builder-api` (API用)
- フロントエンドの.envが間違ったURLを指していた

### 本音

- **なんで2つもWorkerあるんだよ最初に教えてくれ**
- でもcurlでデバッグする習慣があって良かった
- 環境変数のミスは本当に見つけにくい

### 学び

- 複数のサービスがある場合は最初に確認する
- curlでのデバッグは基本中の基本
- 環境変数は一覧化して管理すべき

---

## 2025-07-23 強制デプロイ

### 状況

GitHub
Actionsで S3互換APIのテストがエラー吐いてるけど、デプロイ自体は関係ないから強引にデプロイした。

### 感情

**イライラ → 達成感**

### 詳細

- テストエラーの原因はモックの設定不備
- R2のS3互換APIキーがGitHub Actionsに設定されていない
- でも本番環境は動くはずだから無視してデプロイ

### 本音

- テスト環境と本番環境の差異でイライラ
- CI/CDの設定も面倒くさい
- とりあえず動けばいいや精神で突き進んだ

### 改善案

- GitHub SecretsにR2のS3互換APIキーを設定すべき
- テストをスキップするオプションも検討
- 環境変数の管理を統一したい

---
