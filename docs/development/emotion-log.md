# 感情ログ - エラーと格闘した記録

技術的な実装ログとは別に、開発中に感じた本音や感情を記録します。これはマネジメント改善とメンタルヘルス維持のための重要なドキュメントです。

## 2025-07-24 - APIレスポンス構造の不一致

### 感情: 😫 こういう細かいミスが一番イライラする

### 詳細:

- 画像URLは正しく生成されてるのに表示されない...なんで？？
- curlでアクセスしたら200返ってくる...じゃあフロントの問題か
- あー、APIレスポンスがラップされてるのに直接アクセスしてるじゃん
- `data.image`じゃなくて`data.data.image`だった...
- こういう構造の不一致、マジで時間の無駄

### 反省:

- APIとフロントエンドの契約は最初にしっかり決めるべき
- レスポンス構造は統一すべき（ラップするならすべてラップ）
- 開発者ツールのネットワークタブ、最初に見ればよかった

### 提案:

- TypeScriptでAPI型定義を共有すべき
- レスポンスのバリデーションも入れたい

## 2025-07-24 - R2画像表示問題

### 感情: 😤 よくある問題だけど、すぐに原因がわかってよかった

### 詳細:

- Base64画像のdata URLプレフィックス問題、めっちゃよくある
- でも毎回忘れがちな落とし穴
- 同じ修正が`ImageGenerationI2ISection.tsx`で既にされてたのに、`ImageToImage.tsx`では忘れられてた
- コピペミスか？統一性の欠如がイラッとする
- 共通化すべきロジックが分散してるのもモヤモヤ

### 提案:

- 画像表示のユーティリティ関数作るべき
- `ensureDataUrl(base64: string): string`みたいな関数で統一したい

## 2025-01-24 - 画像生成の表示エラーで混乱

### 状況

本番環境で"画像生成に失敗しました"って表示されるのに、Replicateでは正常に生成されてるし、CloudflareのKVにも画像は保存されてる...

### 感情

😕 **最初の反応**: 「え？生成は成功してるのに失敗表示？？」

🤔 **調査開始**: APIは正常、KVも正常...じゃあフロントエンドか？

😤 **デバッグ中**: Base64データは返ってきてる...なんで表示されないの！

💡 **気づいた瞬間**: 「まさか...data:image/png;base64,のプレフィックスがない？」

😅 **解決時**: そんな基本的なことか...でも気づけてよかった！

### 学んだこと

- 画像生成系のデバッグは各レイヤーを個別に確認することが大事
- Base64画像の表示には必ずデータURLプレフィックスが必要（基本だけど忘れがち）
- 「理論上動いてるはず」と「実際に動く」は違う

## 2025-01-24 - TypeScript型チェックエラーとの戦い

### 状況

GitHub
ActionsでTypeScript型チェックが失敗。processが見つからないとか、型の互換性がないとか...

### 感情

😒 **最初の反応**: 「え、ローカルでは動いてたのに...」

🤔 **調査開始**: process未定義？ブラウザ環境では確かにないな...

😅 **@ts-ignore使用時**: 「とりあえず無視でいいか」→ ESLintに怒られる

😤 **ESLintエラー**: 「@ts-expect-error使えって...違いが分からん」

🎯 **解決時**: インデックスシグネチャ追加で型互換性OK！スッキリ！

### 学んだこと

- ブラウザとNode.jsの環境差は型レベルでも考慮が必要
- @ts-ignoreより@ts-expect-errorの方が厳密（エラーがない場合は警告してくれる）
- インデックスシグネチャは型の柔軟性を上げる便利な機能

## 2025-07-22 - AWS4Fetch実装時の混乱

### 状況

R2
S3互換APIでファイルアップロードを実装しようとしたら、署名付きURLの生成でハマった

### 感情

😤 **最初の感情**: 「S3互換なんだから簡単だろ」→ 甘かった...

😡 **1時間後**: なんでドキュメントにまともな例がないんだよ！AWS
SDKとは微妙に違うし！

🤯 **2時間後**: presignでexpiresIn渡せないってどういうこと？？

😩 **3時間後**: もうダメだ...頭が回らない...コーヒー飲んでくる

😌 **解決時**: あ、awsオブジェクトに直接設定するのか...なんでそんな仕様なの

### 学んだこと

- aws4fetchは軽量だが、ドキュメントが不親切
- S3互換といっても細かい仕様は違う
- 疲れたら無理せず休憩する

---

## 2025-07-22 - TypeScriptの型エラー地獄

### 状況

VSCodeの問題タブに11個のTypeScriptエラーと61個のESLint警告

### 感情

😤 **最初の反応**: またエラーの山か...なんで今まで放置してたんだ

😕 **aws4fetchのエラー**:
expiresInの設定方法がわからない。ドキュメント見ても明確じゃない

🤔 **型定義の混乱**: CategoryとCategoryMaster、なんで名前違うの？統一してくれよ

😓 **テストデータの型エラー**:
predefinedIdとかnameJaとか、どれが正しいプロパティ名なのか混乱する

😊 **エラー解決時**: やっと全部グリーン！気持ちいい

😩 **ESLint警告61件**: まだこんなにあるのか...console.logばっかりじゃん

### 改善提案

- 型定義は最初から一貫性を持たせる（CategoryMasterなのかCategoryなのか決める）
- console.logは開発時のみ出力するユーティリティ関数を作る
- テストデータのモック関数は型安全に作る

### 学び

- aws4fetchの使い方は公式ドキュメントより実装例を見た方が早い
- 型エラーは早めに修正しないと雪だるま式に増える
- Vitestのグローバル関数は明示的にインポートが必要

---

## 2025-07-23 - CORSエラーの原因判明

### 状況

CORSエラーが発生していたが、CORS設定自体は正しかった

### 感情

🤦 **最初**: なんでCORSエラー出るんだよ！設定は正しいはずなのに！

😤 **調査中**: validateOrigin関数でnull返してるけど、これが原因？？

😮
**原因判明**: あー！Honoのcorsミドルウェアはnull返すとCORSヘッダー設定しないのか！

🙄 **修正後**: falseを返せばいいだけだった...なんでドキュメントに書いてないんだ

### 原因

Honoのcorsミドルウェアの仕様:

- null返す→CORSヘッダーを設定しない
- false返す→CORSエラーとして適切に処理

### 教訓

- ミドルウェアの仕様は実装を読まないとわからないことがある
- 「設定は正しいはず」という思い込みは危険

---

## 2025-07-23 - R2アクセスキー設定忘れ

### 状況

画像生成APIが500エラーを返す。原因調査に時間がかかった

### 感情

😑 **最初**: また500エラーか...何が原因だよ

🔍 **調査開始**: ログ見ても詳細がわからない...Cloudflareのログ出力面倒くさい

😤 **コード確認**: R2 S3 API使おうとしてるけど、アクセスキーは...あれ？

🤦‍♂️ **原因判明**:
.dev.varsにR2_ACCESS_KEY_IDとR2_SECRET_ACCESS_KEY設定してないじゃん！

😅 **さらに発見**:
R2_CUSTOM_DOMAINも本番用URL指してるし...開発環境の設定めちゃくちゃ

😩 **修正中**: プレースホルダー追加したけど、実際の値どこから取得すればいいの？

### 問題点

1. 環境変数の設定漏れ（R2アクセスキー）
2. 開発と本番の環境変数が混在
3. エラーメッセージが不親切（500エラーだけじゃわからない）
4. .dev.varsのテンプレートがない

### 改善提案

- .dev.vars.exampleファイルを作成して必須環境変数を明示
- エラーハンドリングをもっと詳細に（開発環境では詳細エラー出力）
- 環境変数のバリデーション処理を追加
- READMEに環境構築手順を詳しく記載

### 学び

- Cloudflare WorkersでR2使うときは環境変数の設定が複雑
- S3互換APIとR2バインディングの使い分けを理解する必要がある
- 開発環境のセットアップドキュメントは重要

---

## 2025-07-24 - 本番環境500エラーの謎

### 状況

本番環境で画像生成APIが500エラー。Replicateには履歴なし、R2にも画像なし。何が起きてるの？

### 感情

😤 **最初**: またエラーか！本番環境でテストするの怖い...

🤔 **調査開始**: Replicateのダッシュボード見ても何もない...APIキー間違ってる？

😕
**R2確認**: 画像もアップロードされてない...そもそもReplicateまで到達してない？

😩 **デバッグの難しさ**: Cloudflareのログどうやって見るんだよ...wrangler tail？

🙄 **404エラー**: あ、GETリクエストしてた。POSTじゃないとダメだった

😫 **まだ500エラー**: POSTでも500...何が原因なんだ！

### 考えられる原因

1. 環境変数が本番環境に設定されていない？
2. Replicateのモデル名が間違っている？
3. リクエストの形式が間違っている？
4. ネットワークエラー？

### 今の気持ち

- Cloudflareのデバッグツール使いにくい
- エラーメッセージが不親切すぎる
- 本番環境でのデバッグストレス高い

### 13:10 原因判明

😅 **あ〜**: デプロイしてないだけだった...

🤦‍♂️ **自分のミス**: 実装したけどデプロイ忘れてた。基本的なミスすぎる

😌
**安心**: でも環境変数はちゃんと設定されてたし、エラーハンドリングも正しく動いてた

🙄 **反省**: デプロイチェックリスト作るべきかも...

### 教訓

- 本番環境のエラー調査の前に、まずデプロイされているか確認
- `wrangler deployments list` でデプロイ履歴を確認
- エラーメッセージは正確だった（APIキーが設定されていない = コードが古い）

### 13:15 新たな問題発生

😤 **別のエラー**: デプロイしたら今度は「画像生成に失敗しました」？？

🤔 **進歩はある**: APIキーは認識されてるから、少なくとも前進してる

😩 **デバッグ困難**: Cloudflareのログ見づらすぎ...wrangler
tailもタイムアウトするし

😠
**イライラ**: 詳細なエラーメッセージ出してくれよ！「失敗しました」じゃ何もわからん

🧐 **推測**: R2のアクセス権限？Replicateとの通信？画像のBase64処理？

### 今の心境

- 一歩進んで二歩下がった気分
- エラーメッセージの重要性を再認識
- ローカルで動作確認すべきだった

### 13:25 モグラ叩き状態

😮‍💨 **疲れてきた**: エラー直しても直しても新しいのが出てくる

✅ **一応進歩**: 404エラーは解決したから前進はしてる

🤔 **新たな謎**: "height and width must be >
0"って、ちゃんと設定したはずなのに...

😤 **推測**: 1x1ピクセルの画像が原因？それともReplicateに画像が届いてない？

🙄 **反省**: 最初からちゃんとしたテスト画像使えばよかった

### エラーの進化

1. APIキーなし → デプロイ忘れ（凡ミス）
2. 404エラー → API仕様の理解不足
3. width/heightエラー → ???（調査中）

### 学び

- エラーメッセージは進歩の証
- 一つ直すと次が見えてくる
- でも疲れる...

---

## 2025-07-24 - Base64画像表示エラーとの格闘

### 状況

Replicateで画像生成は成功してるのに、ブラウザで表示されない。なぜ...？

### 感情

😕
**最初の反応**: 「画像生成は成功してるって言ってるのに、なんで表示されないの？」

🔍 **調査開始**: コード追跡...バックエンド→フロントエンド→あ、そうか！

🤦‍♂️ **原因判明**:
data:image/png;base64,プレフィックスが無いじゃん！Base64文字列だけ返してた

😤
**イライラ**: こんな基本的なことで時間取られるなんて...でも意外とあるあるなミス

😊 **修正完了**: たった3行の修正で解決。シンプルな原因ほど見つけにくい

### 問題点

1. Base64画像の表示にはdata URLプレフィックスが必須
2. バックエンドとフロントエンドのデータ形式の不一致
3. エラーメッセージが不親切（画像が表示されないだけ）

### 解決策

```typescript
// プレフィックスがなければ追加
const imageDataUrl = result.image.startsWith('data:')
  ? result.image
  : `data:image/png;base64,${result.image}`;
```

### 学び

- データ形式の仕様は両端で必ず確認
- ブラウザのデベロッパーツールで画像ソースを確認すればすぐ分かった
- 小さなミスほど見落としやすい

---

## 2025-07-24 - CUDA Out of Memory エラーとの戦い

### 感情

**うわぁ...またGPUメモリエラーか！！スマホの写真がそんなにデカいとは...**

### 状況

- スマホ写真アップロードでCUDA OOMエラー
- 5.81GiBも要求して失敗
- 本番環境でユーザーが困ってる

### イライラポイント

1. **「なんでImageToImageだけリサイズ処理ないんだよ！」**
   - ImageStepでは実装してるのに
   - 明らかな実装漏れじゃん
2. **「GPUメモリ44GBもあるのに足りないとか...」**
   - 最近のスマホ写真デカすぎ
   - 4K、8K当たり前の時代か...

3. **「FLUX系モデル重すぎだろ」**
   - 1MPで処理とか贅沢すぎ
   - 512x512で十分じゃん

### やったこと

- フロントで自動リサイズ追加（やっと）
- バックエンドでサイズチェック強化
- FLUXパラメータを現実的な値に調整

### スッキリしたこと

- リサイズ処理がちゃんと動いた
- メモリエラー回避できそう
- パラメータ調整でメモリ節約

### 学んだこと

- **画像処理は事前リサイズが命**
- GPU強くてもアルゴリズムには勝てない
- ユーザーは高解像度画像を平気でアップする

### 本音

もっと早くリサイズ処理入れとけばよかった...でも今回で確実に改善したから良し！

---
